<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-M-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NisharAI</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        /* Custom scrollbar for chat area */
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #d1d5db; /* gray-300 */
            border-radius: 10px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* gray-400 */
        }

        /* Basic markdown-like styling */
        .ai-message p {
            margin-bottom: 0.5rem;
        }
        .ai-message ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .ai-message ol {
            list-style-type: decimal;
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .ai-message code {
            background-color: #f3f4f6; /* gray-100 */
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .ai-message pre {
            background-color: #1f2937; /* gray-800 */
            color: #f9fafb; /* gray-50 */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        .ai-message pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            font-size: 0.875rem;
        }
        /* Style for the image preview */
        #image-preview-container {
            position: relative;
            display: none; /* Hidden by default */
            margin-bottom: 0.5rem;
        }
        #image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb; /* gray-200 */
        }
        #remove-image-btn {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background-color: #ef4444; /* red-500 */
            color: white;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.875rem;
            line-height: 1;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Main Application Container -->
    <div id="app" class="flex h-screen flex-col">

        <!-- Header -->
        <header class="bg-white border-b border-gray-200 w-full p-4 shadow-sm">
            <div class="max-w-5xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                    <h1 class="text-xl font-semibold text-gray-800">NisharAI</h1>
                </div>
                <button id="new-chat-btn" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                    New Chat
                </button>
            </div>
        </header>

        <!-- Chat Container -->
        <main class="flex-1 overflow-y-auto" id="chat-container">
            <div class="max-w-3xl mx-auto p-4 md:p-6 space-y-6">

                <!-- Welcome Message -->
                <div id="welcome-message" class="text-center p-8 bg-white rounded-lg shadow-sm border border-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500 mx-auto mb-4"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                    <h2 class="text-2xl font-semibold text-gray-800">How can I help you today?</h2>
                    <p class="text-gray-500 mt-2">Ask me anything! Type your question in the box below to get started.</p>
                </div>

                <!-- Chat messages will be appended here -->
                <div id="chat-messages" class="space-y-6">
                    <!--
                    Example User Message:
                    <div class="flex justify-end">
                        <div class="bg-indigo-600 text-white p-4 rounded-lg rounded-br-none max-w-lg shadow">
                            Hello, how does the Gemini API work?
                        </div>
                    </div>

                    Example AI Message:
                    <div class="flex justify-start">
                        <div class="bg-white text-gray-800 p-4 rounded-lg rounded-bl-none max-w-lg shadow border border-gray-200 ai-message">
                            <p>The Gemini API is a family of multimodal models...</p>
                            <p>You can interact with it via an API endpoint.</p>
                        </div>
                    </div>
                    -->
                </div>

                <!-- Loading Indicator -->
                <div id="loading-indicator" class="hidden flex justify-start">
                    <div class="bg-white text-gray-800 p-4 rounded-lg rounded-bl-none max-w-lg shadow border border-gray-200">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                            <span class="text-sm text-gray-500">AI is thinking...</span>
                        </div>
                    </div>
                </div>

                <!-- Error Message Container -->
                <div id="error-message" class="hidden">
                    <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg shadow-sm">
                        <h4 class="font-bold">An error occurred</h4>
                        <p id="error-text"></p>
                    </div>
                </div>

            </div>
        </main>

        <!-- Input Area -->
        <footer class="bg-white border-t border-gray-200 p-4 sticky bottom-0">
            <div class="max-w-3xl mx-auto">
                <!-- Image Preview -->
                <div id="image-preview-container">
                    <img id="image-preview" src="" alt="Image preview">
                    <button id="remove-image-btn" title="Remove image">&times;</button>
                </div>
                <!-- Location Info -->
                <div id="location-info" class="hidden text-xs text-gray-500 mb-2 p-2 bg-gray-50 rounded-md border">
                    <span id="location-text"></span>
                    <button id="remove-location-btn" class="ml-2 text-red-500 font-medium">[Remove]</button>
                </div>

                <form id="chat-form" class="flex items-center space-x-3">
                    <!-- Hidden File Input -->
                    <input type="file" id="image-upload-input" accept="image/*" class="hidden">
                    
                    <!-- Location Button -->
                    <button type="button" id="location-button" class="p-3 text-gray-500 hover:text-indigo-600 focus:outline-none transition" title="Add Location">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    </button>
                    
                    <!-- Image Upload Button -->
                    <button type="button" id="image-upload-button" class="p-3 text-gray-500 hover:text-indigo-600 focus:outline-none transition" title="Attach Image">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-paperclip"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    </button>

                    <input type="text" id="prompt-input" placeholder="Message your AI..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" autocomplete="off">
                    <button type="submit" id="send-button" class="bg-indigo-600 text-white p-3 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal"><path d="m3 3 3 9-3 9 19-9Z"></path><path d="m6 12h16"></path></svg>
                    </button>
                </form>
                <p class="text-xs text-gray-400 text-center mt-2">
                    This is a demo. AI may produce inaccurate information.
                </p>
            </div>
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const chatForm = document.getElementById('chat-form');
            const promptInput = document.getElementById('prompt-input');
            const sendButton = document.getElementById('send-button');
            const chatMessages = document.getElementById('chat-messages');
            const chatContainer = document.getElementById('chat-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const newChatButton = document.getElementById('new-chat-btn');
            const welcomeMessage = document.getElementById('welcome-message');
            
            // New elements for image and location
            const imageUploadInput = document.getElementById('image-upload-input');
            const imageUploadButton = document.getElementById('image-upload-button');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const removeImageButton = document.getElementById('remove-image-btn');
            const locationButton = document.getElementById('location-button');
            const locationInfo = document.getElementById('location-info');
            const locationText = document.getElementById('location-text');
            const removeLocationButton = document.getElementById('remove-location-btn');


            // --- API Configuration ---
            // 
            // ===================================================================
            // !!! IMPORTANT !!!
            // PASTE YOUR GOOGLE GEMINI API KEY HERE
            // ===================================================================
            const API_KEY = "AIzaSyALtG8G1BaRiOLOGEzABAIc-ISIxrJ9vIA"; // <--- PASTE YOUR KEY HERE
            //
            const API_URL = `httpshttps://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

            // --- State ---
            let conversationHistory = []; // Stores { role: "user" | "model", parts: [{ text: "..." }] }
            let uploadedImageBase64 = null; // Stores the base64 string of the uploaded image
            let locationString = null; // Stores the fetched location string

            // --- Event Listeners ---
            chatForm.addEventListener('submit', handleFormSubmit);
            newChatButton.addEventListener('click', startNewChat);
            imageUploadButton.addEventListener('click', () => imageUploadInput.click());
            imageUploadInput.addEventListener('change', handleImageUpload);
            removeImageButton.addEventListener('click', removeUploadedImage);
            locationButton.addEventListener('click', fetchLocation);
            removeLocationButton.addEventListener('click', removeLocation);

            // --- Functions ---
 
                // Build the user message parts
                const userParts = [{ text: userPrompt }];

                // Add image if one is uploaded
                if (uploadedImageBase64) {
                    const mimeType = imageUploadInput.files[0]?.type || 'image/png'; // Get mime type from file
                    userParts.push({
                        inlineData: {
                            mimeType: mimeType,
                            data: uploadedImageBase64
                        }
                    });
                }
                
                // Add location if present
                if (locationString) {
                    userParts[0].text = `My location is: ${locationString}. ${userPrompt}`;
                }

                // Add to history
                conversationHistory.push({ role: "user", parts: userParts });

                // Clear input, remove image, remove location, and show loading
                promptInput.value = '';
                removeUploadedImage();
                removeLocation();
                showLoading(true);
                disableInput(true);
                hideError();

                try {
                    // Call the Gemini API
                    const aiResponse = await callGeminiAPI(conversationHistory);
                    
                    // Add AI response to history
                    conversationHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    
                    // Display AI message
                    appendMessage(aiResponse, 'model');

                } catch (error) {
                    console.error("Error calling API:", error);
                    displayError(`Failed to get response: ${error.message}. Check your API key and network connection.`);
                } finally {
                    // Hide loading and re-enable input
                    showLoading(false);
                    disableInput(false);
                    promptInput.focus();
                }
            }

            /**
             * Calls the Gemini API with the current conversation history
             */
            async function callGeminiAPI(history) {
                const payload = {
                    contents: history,
                    // Optional: Add safety settings or generation config here
                    // generationConfig: {
                    //     "temperature": 1,
                    //     "topP": 0.95,
                    //     "topK": 64,
                    //     "maxOutputTokens": 8192,
                    // }
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error?.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Check for valid response structure
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    // Check for safety stop
                    if (result.candidates[0].finishReason === "SAFETY") {
                        return "Response was blocked due to safety concerns.";
                    }
                    return result.candidates[0].content.parts[0].text;
                } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                     return `Request was blocked: ${result.promptFeedback.blockReason}`;
                } else {
                    return "AI returned an empty or invalid response.";
                }
            }

            /**
             * Appends a message to the chat window
             */
            function appendMessage(content, sender) {
                const messageWrapper = document.createElement('div');
                const messageElement = document.createElement('div');

                // Basic Markdown-to-HTML conversion - REMOVED * for bold/italic/lists
                let htmlContent = content
                    .replace(/</g, "&lt;").replace(/>/g, "&gt;") // Escape HTML
                    // .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // REMOVED
                    // .replace(/\*(.*?)\*/g, '<em>$1</em>') // REMOVED
                    .replace(/```([\s\S]*?)```/g, (match, code) => { // Code blocks
                        const language = ''; // Simple version, no lang detection
                        const escapedCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        return `<pre><code class="${language}">${escapedCode.trim()}</code></pre>`;
                    })
                    .replace(/`(.*?)`/g, '<code>$1</code>') // Inline code
                    // Replace list items with a simple dash and a line break
                    .replace(/^(?:-|\*)\s(.*?)$/gm, '- $1<br>')
                    .replace(/\n/g, '<br>'); // Newlines
                
                // Fix potential double line breaks from lists
                htmlContent = htmlContent.replace(/<br><br>/g, '<br>');

                messageElement.innerHTML = htmlContent;
                messageElement.classList.add('ai-message'); // For markdown styling

                if (sender === 'user') {
                    messageWrapper.classList.add('flex', 'justify-end');
                    messageElement.classList.add('bg-indigo-600', 'text-white', 'p-4', 'rounded-lg', 'rounded-br-none', 'max-w-lg', 'shadow');
                } else {
                    messageWrapper.classList.add('flex', 'justify-start');
                    messageElement.classList.add('bg-white', 'text-gray-800', 'p-4', 'rounded-lg', 'rounded-bl-none', 'max-w-lg', 'shadow', 'border', 'border-gray-200');
                }

                messageWrapper.appendChild(messageElement);
                chatMessages.appendChild(messageWrapper);
                
                // Scroll to the bottom
                scrollToBottom();
            }

            /**
             * Resets the chat interface
             */
            function startNewChat() {
                chatMessages.innerHTML = '';
                conversationHistory = [];
                hideError();
                showLoading(false);
                disableInput(false);
                removeUploadedImage(); // Clear image on new chat
                removeLocation(); // Clear location on new chat
                if (welcomeMessage) {
                    welcomeMessage.classList.remove('hidden');
                }
                promptInput.focus();
            }

            /**
             * Shows or hides the loading indicator
             */
            function showLoading(isLoading) {
                loadingIndicator.classList.toggle('hidden', !isLoading);
                if (isLoading) scrollToBottom();
            }

            /**
            * Disables or enables the input field and send button
            */
            function disableInput(isDisabled) {
                promptInput.disabled = isDisabled;
                sendButton.disabled = isDisabled;
            }

            /**
             * Displays an error message
             */
            function displayError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                scrollToBottom();
            }

            /**
             * Hides the error message
             */
            function hideError() {
                errorMessage.classList.add('hidden');
            }

            /**
             * Scrolls the chat container to the bottom
             */
            function scrollToBottom() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // --- New Functions for Image and Location ---

            /**
             * Handles the file input change event
             */
            function handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64String = event.target.result;
                    // Store only the base64 data, not the prefix
                    uploadedImageBase64 = base64String.split(',')[1]; 
                    
                    imagePreview.src = base64String;
                    imagePreviewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }

            /**
             * Removes the uploaded image preview and clears the state
             */
            function removeUploadedImage() {
                uploadedImageBase64 = null;
                imagePreview.src = '';
                imagePreviewContainer.style.display = 'none';
                // Reset the file input
                imageUploadInput.value = null; 
            }

            /**
             * Fetches the user's current location
             */
            async function fetchLocation() {
                if (!navigator.geolocation) {
                    displayError("Geolocation is not supported by your browser.");
                    return;
                }

                locationButton.disabled = true;
                locationText.textContent = "Fetching location...";
                locationInfo.classList.remove('hidden');

                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                    });

                    const { latitude, longitude } = position.coords;
                    
                    // Use Nominatim for reverse geocoding (free, no API key)
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    if (!response.ok) throw new Error('Failed to reverse geocode.');
                    
                    const data = await response.json();
                    
                    if (data.display_name) {
                        locationString = data.display_name;
                        locationText.textContent = `Location: ${locationString}`;
                        locationButton.classList.add('text-indigo-600'); // Show as active
                    } else {
                        throw new Error('Could not find address.');
                    }

                } catch (error) {
                    console.error("Location Error:", error);
                    locationText.textContent = `Error: ${error.message}`;
                    locationString = null;
                    setTimeout(removeLocation, 3000); // Hide error after 3s
                } finally {
                    locationButton.disabled = false;
                    if (!locationString) {
                         locationInfo.classList.add('hidden');
                    }
                }
            }

            /**
             * Removes the fetched location
             */
            function removeLocation() {
                locationString = null;
                locationInfo.classList.add('hidden');
                locationText.textContent = '';
                locationButton.classList.remove('text-indigo-600');
            }


            // Initial focus on input
            promptInput.focus();
        });
    </script>
</body>
</html>
